<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="searchMapper">

	<resultMap id="memberResultSet" type="Member">
		<id property="mNo" column="M_NO"/>
		<result property="userId" column="M_ID"/>
		<result property="userName" column="M_NAME"/>
		<result property="userPwd" column="M_PWD"/>
		<result property="email" column="M_EMAIL"/>
		<result property="interestes" column="INTERESTES"/>
		<result property="gNo" column="G_NO"/>
		<result property="mStatus" column="M_STATUS"/>
		<result property="mImage" column="M_IMAGE"/>
 		<result property="mRenameImage" column="M_RENAME_IMAGE"/>
		<result property="cDate" column="CREATE_DATE"/>
		<result property="mLevel" column="M_LEVEL"/>
		<result property="mIntro" column="M_INTRO"/>
	</resultMap>
	
	<resultMap id="feedResultSet" type="Feed">
		<id property="fNo" column="F_NO"/>
		<result property="mNo" column="M_NO"/>
		<result property="fContent" column="F_CONTENT"/>
		<result property="fWriter" column="F_WRITER"/>
		<result property="fFile" column="F_FILE"/>
		<result property="fRenameFile" column="F_RENAMEFILE"/>
		<result property="fCreateDate" column="F_CREATE_DATE"/>
		<result property="fModifyDate" column="F_MODIFY_DATE"/>
		<result property="fStatus" column="F_STATUS"/>
		<result property="fLocation" column="F_LOCATION"/>
		<result property="fOpenScope" column="F_OPEN_SCOPE"/>
		<result property="fLikeSet" column="F_LIKE_SET"/>
		<result property="fReplySet" column="F_REPLY_SET"/>
		<result property="fShareSet" column="F_SHARE_SET"/>
		<result property="fLikeCnt" column="F_LIKECNT"/>
		<result property="fReplyCnt" column="F_REPLYCNT"/>
	</resultMap>
	
	<resultMap id="relatedSearchSet" type="RelatedSearch">
		<result property="rsNo" column="RNUM"/>
		<result property="rsTag" column="TATG"/>
		<result property="rsCnt" column="SUMC"/>
	</resultMap>
	
	<resultMap id="GroupResultSet" type="Group">
		<id property="gNo" column="G_NO"/>
		<result property="gCreator" column="G_CREATOR"/>
		<result property="gName" column="G_NAME"/>
		<result property="gCategory" column="G_CATEGORY"/>
		<result property="gMax" column="G_MAX"/>
		<result property="gDate" column="G_DATE"/>
		<result property="gOpenScope" column="G_OPENSCOPE"/>
		<result property="gJoinSet" column="G_JOINSET"/>
		<result property="gQset" column="G_QSET"/>
		<result property="q1" column="Q1"/>
		<result property="q2" column="Q2"/>
		<result property="q3" column="Q3"/>
		<result property="gIntro" column="G_INTRO"/>
		<result property="gTag" column="G_TAG"/>
		<result property="gStatus" column="G_STATUS"/>
		<result property="gNotice" column="G_NOTICE"/>
		<result property="gProfile" column="G_PROFILE"/>
		<result property="gImage" column="G_IMAGE"/>
		<result property="gRenameProfile" column="G_RENAME_PROFILE"/>
		<result property="gRenameImage" column="G_RENAME_IMAGE"/>
	</resultMap>
	
	
	<select id="searchMember" parameterType="Search" resultMap="memberResultSet">
		SELECT * FROM MEMBER
		WHERE M_LEVEL='M'
		<if test="searchType=='@' and search!=null">
		AND M_ID LIKE '%' || #{search}  || '%'
		</if>
		<if test="searchType=='#' and search!=null">
		AND M_INTRO LIKE '%' || #{search}  || '%'
		</if>
	</select>
	
	<select id="searchGroup" parameterType="Search" resultMap="GroupResultSet">
		SELECT G_NO,G_NAME,G_RENAME_PROFILE,G_RENAME_IMAGE
		FROM GROUPS
		WHERE G_STATUS='Y'
		AND G_TAG LIKE '%'||#{search}||'%'
	</select>
	
	
	<select id="searchFeed" parameterType="Search" resultMap="feedResultSet">
		SELECT * FROM FEED
		WHERE F_OPEN_SCOPE='Y'
		AND F_STATUS='Y'
		<if test="searchType=='#' and search!=null">
		AND F_CONTENT LIKE '%' || #{search}  || '%'
		</if>
		<if test="searchType=='@' and search!=null">
		AND F_CONTENT LIKE '%' || #{search}  || '%'
		</if>
	</select>
	<!-- 
	<select id="relatedSearch" parameterType="Search" resultMap="relatedSearchSet">
	<![CDATA[
	SELECT ROWNUM, TC.*
	FROM (
	    SELECT TB.TATG, SUM(CNT) SUMC
	    FROM(
	        SELECT TA.F_TAG AS TATG, COUNT(TA.F_TAG) CNT
	        FROM TAG TA
	        WHERE TA.F_NO IN(SELECT F_NO 
	                        FROM TAG
	                        WHERE F_TAG= #{search} )
	        AND NOT TA.F_TAG = #{search} 
	        GROUP BY TA.F_NO, TA.F_TAG) TB
	    GROUP BY TB.TATG
	    ORDER BY SUMC DESC) TC
	WHERE ROWNUM < 10
	]]>
	</select>	
 -->
	<select id="relatedSearch" parameterType="Search" resultType="String" >
	<![CDATA[
	SELECT RTAG.TATG FROM(
		SELECT ROWNUM, TC.*
		FROM (
		    SELECT TB.TATG, SUM(CNT) SUMC
		    FROM(
		        SELECT TA.F_TAG AS TATG, COUNT(TA.F_TAG) CNT
		        FROM TAG TA
		        WHERE TA.F_NO IN(SELECT F_NO 
		                        FROM TAG
		                        WHERE F_TAG= #{search} )
		        AND NOT TA.F_TAG = #{search} 
		        GROUP BY TA.F_NO, TA.F_TAG) TB
		    GROUP BY TB.TATG
		    ORDER BY SUMC DESC) TC
		WHERE ROWNUM < 10 ) RTAG
	]]>
	</select>
	
	<!-- 
	<select id="tagsearchFeed" parameterType="arraylist" resultMap="feedResultSet">
	SELECT FD.*
	FROM FEED FD
	WHERE F_NO IN(SELECT F_NO 
	            	FROM FEED
	            	WHERE
	            	F_STATUS ='Y'
	            	<foreach collection="list" item="item" open="(" close=")" separator=",">
	            	<if test="list != null">
	            	AND 
	            	</if>
	            	F_CONTENT LIKE '%'|| #{list.item} ||'%'
	            	</foreach>
					);
	</select>
	 -->
	 
	<select id="tagSearchFeed" parameterType="String" resultMap="feedResultSet">
	SELECT FD.*
	FROM FEED FD
	WHERE F_NO IN(SELECT F_NO 
	            	FROM FEED
	            	WHERE
	            	F_STATUS ='Y'
	            	<foreach collection="array" item="arr" open="" close="" separator="">
	            	<if test="array != null">
	            	AND 
	            	</if>
	            	F_CONTENT LIKE '%'|| #{arr} ||'%'
	            	</foreach>
					)
	</select>
	
	<select id="tagSearchRs" parameterType="String" resultType="String">
	SELECT RCRT.F_TAG
	FROM(SELECT ROWNUM, TC.F_TAG
	    FROM( SELECT TB.F_TAG, COUNT(TB.F_TAG) CNT
	            FROM TAG TB
	            WHERE TB.F_NO IN(SELECT F_NO 
	                            FROM FEED
	   							WHERE 
	   							F_STATUS ='Y'
	   							<if test="array != null">
				            	AND 
				            	</if>
	            				<foreach collection="array" item="arr" open="" close="" separator="AND">
	                            F_CONTENT LIKE '%'||#{arr}||'%'
	                            </foreach>
	                            )
				<if test="array != null">
            	AND 
            	</if>
				<foreach collection="array" item="arr" open="" close="" separator="AND">
	            NOT TB.F_TAG=#{arr}
                </foreach>
	            GROUP BY TB.F_NO, TB.F_TAG
	            ORDER BY CNT DESC) TC
	<![CDATA[
	WHERE ROWNUM < 10) RCRT
	]]>
	</select>
	
	<select id="tagSearchGroup" parameterType="String" resultMap="GroupResultSet">
	SELECT *
	FROM GROUPS
	WHERE G_STATUS='Y'
	<if test="array != null">
    AND 
    </if>
	<foreach collection="array" item="arr" open="" close="" separator="AND">
	G_TAG LIKE '%'||#{arr}||'%'
	</foreach>
	
	</select>
	
	<select id="tagSearchMember" parameterType="String" resultMap="memberResultSet">
	SELECT * FROM MEMBER
	WHERE
	M_LEVEL ='M'
	<if test="array != null">
    AND 
    </if>
	<foreach collection="array" item="arr" open="" close="" separator="AND">
	M_INTRO LIKE  '%'||#{ arr }||'%'
	</foreach>
	</select>
</mapper>
